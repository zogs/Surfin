<html>
<head>

	<title></title>
	<script src=" http://code.createjs.com/createjs-2013.12.12.min.js"></script>
	<script>

	var stage,
		surfer,
		silhouette,
		queue,
		mouseX,
		mouseY;
		dX = 60,
		dY = -15;

	function load(){

		stage = new createjs.Stage('myCanvas');
		stage.width = 1500;
		stage.height = 500;

		mouseX = stage.width/2;
		mouseY = stage.height/2;

		queue = new createjs.LoadQueue();
		queue.addEventListener('complete',init);
		queue.loadManifest([
			{id:'bkg_paradize',src:'assets/img/bkg/paradize.jpg'},
			{id:'wave',src:'assets/img/waves/wave1.jpg'},
			{id:'surfer_W',src:'assets/img/surfer/W.png'},
			{id:'surfer_NW',src:'assets/img/surfer/NW.png'},
			{id:'surfer_N',src:'assets/img/surfer/N.png'},
			{id:'surfer_NE',src:'assets/img/surfer/NE.png'},
			{id:'surfer_E',src:'assets/img/surfer/E.png'},
			{id:'surfer_SE',src:'assets/img/surfer/SE.png'},
			{id:'surfer_S',src:'assets/img/surfer/S.png'},
			{id:'surfer_SW',src:'assets/img/surfer/SW.png'}
			]);

	}

	function init(){

		bkg = new createjs.Bitmap(queue.getResult('bkg_paradize'));
		stage.addChild(bkg);


		wave = new createjs.Container();
		wave.x = 0;
		wave.y = 200;
		wave.width = 1500;
		wave.height = 200;
		wave.breaking_width = 10;
		wave.breaking_width_variation = 10;
		wave.breaking_speed = 50;
		wave.breaking_speed_variation = 0;
		wave.hasBreak = false;
		wave.breaking_time = 2000;
		wave.breaking_time_variation = 1000;
		wave.duration = 30000;
		wave.duration_variation = 2000;
		wave.peak_width = 80;
		wave.peak_frequency = 3000;
		wave.peak_frequency_variation = 3000;
		wave.center = wave.width/2;
		wave.expansed_width = 0;
		wave.expansed_delay = 0;	
		wave.moving = false;
		wave.direction = 0;	
		stage.addChild(wave);

		wave_bkg = new createjs.Container();
		//wave_bkg = new createjs.Bitmap(queue.getResult('wave'));
		//wave_bkg.setTransform(-wave.width,0,wave.width*3);		
		wave.addChild(wave_bkg);
		

		lip = new createjs.Container();
		wave.addChild(lip);

		splashPoints = new createjs.Container();
		lip.addChild(splashPoints);
		lip_points = [];

		lipcurve = new createjs.Container();
		lip.addChild(lipcurve);



		
		surfer = new createjs.Container();
		surfer.x = stage.width/2;
		surfer.y = wave.y;
		surfer.isOnWave = true;
		stage.addChild(surfer);

		silhouette = new createjs.Container();
		silhouette.x = -40;
		silhouette.y = -40;		
		surfer.addChild(silhouette);

		surferDebug = new createjs.Container();
		surfer.addChild(surferDebug);
		

		//variations
		initWaveVariations();


		stage.addEventListener('stagemousemove',onMouseMove);
		createjs.Ticker.addEventListener('tick',tick);


		initWaveBreaking();

		
	}


	function initWaveVariations()
	{
		//speed breaking variation
		waveVariationBreakingSpeed = new createjs.Shape();
		waveVariationBreakingSpeed.graphics.beginFill('#dff0f4').drawCircle(0,0,4);
		waveVariationBreakingSpeed.x = wave.breaking_speed;
		initWaveVariationBreakingSpeed();
		//width breaking variation
		waveVariationBreakingWidth = new createjs.Shape();
		waveVariationBreakingWidth.graphics.beginFill('#dffF68').drawCircle(0,0,4);
		waveVariationBreakingWidth.x = wave.breaking_width;
		initWaveVariationBreakingWidth();
		//breaking time variation
		waveVariationBreakingTime = new createjs.Shape();
		waveVariationBreakingTime.graphics.beginFill('#dff0f4').drawCircle(0,0,4);
		waveVariationBreakingTime.x = wave.breaking_time;
		initWaveVariationBreakingTime()
		//point break variation
		initVariationNewBreakingPeak();

		waveVariationHeight = new createjs.Shape();
		waveVariationHeight.graphics.beginFill('red').drawCircle(0,0,4);
		waveVariationHeight.x = 0;
		//initWaveVariationHeight();
	
	}

	function initVariationNewBreakingPeak(){
		
		var min = wave.peak_frequency - wave.peak_frequency_variation;
		var max = wave.peak_frequency + wave.peak_frequency_variation;
		var time = Math.random()*max+min;
		setTimeout(createNewBreakingPeak,time);
	}

	function createNewBreakingPeak(){
		
		var distance = 150;
		var width = 200;
					
		var current = wave.expansed_width+wave.center+waveVariationBreakingWidth.x;

		var i = 0;
		while(i<=width){

			var x = current + i;
			point = createWaveBreakingPoint(x,'red',0,waveVariationBreakingTime.x);
			lip_points.push(point);

			i+= waveVariationBreakingWidth.x;
			wave.expansed_width += waveVariationBreakingWidth.x;
		}
		
				

		initVariationNewBreakingPeak();
	}

	function initWaveVariationHeight(){

		var min = wave.duration;
		var max = wave.duration + Math.random()*wave.duration_variation;
		createjs.Tween.get(waveVariationHeight)
			.to({x:wave.height},min+max,createjs.Ease.easeInCirc)
			.call(waveIsEnded);
	}

	function waveIsEnded(){

		console.log('wave ended');
	}

	function initWaveVariationBreakingSpeed(){
		
		var min = wave.breaking_speed - wave.breaking_speed_variation;
		var max = wave.breaking_speed + wave.breaking_speed_variation;
		var time = 3000;
		var wait = 1000;
		createjs.Tween.get(waveVariationBreakingSpeed)
			.to({x:max},Math.random()*time+time/3)
			.wait(Math.random()*wait+wait/3)
			.to({x:min},Math.random()*time+time/3)
			.call(initWaveVariationBreakingSpeed);
	}

	function initWaveVariationBreakingWidth(){
		
		var min = wave.breaking_width;
		var max = wave.breaking_width + wave.breaking_width_variation;
		var time = 3000;
		var wait = 1000;
		createjs.Tween.get(waveVariationBreakingWidth)
			.to({x:max},Math.random()*time+time/3)
			.wait(Math.random()*wait+wait/3)
			.to({x:min},Math.random()*time+time/3)
			.call(initWaveVariationBreakingWidth);
	}

	function initWaveVariationBreakingTime(){
		
		var min = wave.breaking_time;
		var max = wave.breaking_time + wave.breaking_time_variation;	
		var time = 600;
		var wait = 7000;
		createjs.Tween.get(waveVariationBreakingTime)
			.wait(Math.random()*wait+2000)
			.to({x:max},time)
			.to({x:min},time)			
			.call(initWaveVariationBreakingTime);
	}

	function onMouseMove(evt){

		setMousePosition(evt);

		moveWaveVision();
	}

	function setMousePosition(evt){
		mouseX = evt.stageX;
		mouseY = evt.stageY;
	}

	function moveSurfer(evt){

		var difX = mouseX - surfer.x;
		var difY = mouseY - surfer.y;

		var vWaveX = wave.breaking_width;
		var vWaveY = 3;

		surfer.x += (difX - vWaveX) / 10;
		surfer.y += (difY - vWaveY) / 10;
			
		var debug = 'difX: '+Math.round(difX)+' - vWaveX: '+Math.round(vWaveX)+' \n'
					+'difY: '+Math.round(difY)+ ' -vWaveY: '+Math.round(vWaveY);			
		//debug
		surferDebug.removeAllChildren();
		var line = new createjs.Shape();
		line.graphics.beginStroke('red').setStrokeStyle(1).moveTo(0,0).lineTo(difX,difY);
		surferDebug.addChild(line);
		var text = new createjs.Text(debug, "12px Arial", "red"); 
		text.x = difX - 50;
		text.y = difY + 20;
		text.textBaseline = "alphabetic";
		surferDebug.addChild(text);

			//createjs.Tween.get(surfer,{override:true}).to({x:mouseX,y:mouseY},600);

		//replace the direction silouette
		var a = Math.atan2(surfer.x-mouseX,surfer.y-mouseY);
		var deg = a*(180/Math.PI);
		silhouette.removeChildAt(0);
		silhouette.addChild(angledSilhouette(deg));

	}

	function moveWaveVision(evt){

		//wave.x = (wave.center-surfer.x)*300/wave.width;
		//createjs.Tween.get(wave,{override:true}).to({x:mouseX},1000);
	}

	function angledSilhouette(deg){
		if(deg<=22.5&&deg>-22.5) return new createjs.Bitmap(queue.getResult('surfer_N'));
		if(deg>22.5&&deg<=67.5) return new createjs.Bitmap(queue.getResult('surfer_NW'));
		if(deg>67.5&&deg<=112.5) return new createjs.Bitmap(queue.getResult('surfer_W'));
		if(deg>112.5&&deg<=157.5) return new createjs.Bitmap(queue.getResult('surfer_SW'));
		if(deg>157.5||deg<=-157.5) return new createjs.Bitmap(queue.getResult('surfer_S'));
		if(deg>-157.5&&deg<=-112.5) return new createjs.Bitmap(queue.getResult('surfer_SE'));
		if(deg>-112.5&&deg<=-67.5) return new createjs.Bitmap(queue.getResult('surfer_E'));
		if(deg>-67.5&&deg<=-22.5) return new createjs.Bitmap(queue.getResult('surfer_NE'));
	}

	function surferTrail(){

		var trail = new createjs.Shape();
		trail.graphics.beginFill('#dff0f4').drawCircle(0,0,4);
		trail.x = surfer.x;
		trail.y = surfer.y;

		stage.addChild(trail);

		createjs.Tween.get(trail).to({
			x:trail.x+dX,
			y:trail.y+dY,
			alpha:0,
			scaleX:5,
			scaleY:5
		},700).call(deleteTrail);
	}

	function deleteTrail(evt){

		evt.target.removeAllEventListeners();
		stage.removeChild(evt.target);
	}

	function getDistance(x1,y1,x2,y2){

		return Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2));
	}


	

	function initWaveBreaking(){

		var middle = createWaveBreakingPoint(wave.center,'red',0);
		lip_points.push(middle);

		var right = createWaveBreakingPoint(wave.center+wave.peak_width/2);
		lip_points.push(right);

		var left = createWaveBreakingPoint(wave.center-wave.peak_width/2);
		lip_points.unshift(left);

		wave.expansed_width += wave.peak_width/2;
				
		setTimeout(perpetualBreaking,wave.breaking_speed);
	}


	function perpetualBreaking(){

		//remove first point when is off the screen
		var nbpoints = lip_points.length;

		//loop the points and remove those off screen
		for(var i = 0; i<=nbpoints-1; i++){
			var point = lip_points[i];
			var pos = point.x + lip.x + wave.x;
			if(pos < - wave.width ){
				splashPoints.removeChild(point);
				lip_points.slice(0,1);
			}
			if(pos > wave.width*2){
				splashPoints.removeChild(point);
				lip_points.slice(lip_points.length-1,1);				
			}							
		}
		

		//add new point at the right shoulder of the wave
		var x = wave.center + wave.expansed_width + waveVariationBreakingWidth.x;
		var point = createWaveBreakingPoint(x,'blue');
		lip_points.push(point);

		//add new point at the right shoulder of the wave
		x = wave.center - wave.expansed_width - waveVariationBreakingWidth.x;
		point = createWaveBreakingPoint(x,'blue');
		lip_points.unshift(point);

		//set expansion width pixel
		wave.expansed_width += waveVariationBreakingWidth.x;
		
		setTimeout(perpetualBreaking,wave.breaking_speed);
	}

	function createWaveBreakingPoint(x,color,delay,time){
		if(typeof(delay)==='undefined') delay = wave.expansed_delay + wave.breaking_speed;
		if(typeof(time)==='undefined') time = waveVariationBreakingTime.x;
		if(typeof(color)==='undefined') color = 'red';

		var point = new createjs.Container();
		point.x = x;
		point.y = waveVariationHeight.x;
		splashPoints.addChild(point);

		var shape = new createjs.Shape();	
		shape.graphics.beginFill(color).drawCircle(0,0,5);	
		point.addChild(shape);

		createjs.Tween.get(point)
			.wait(delay)
			.to(
				{y:wave.height},
				time+Math.random()*50,
				createjs.Ease.quartIn
				)
			.call(splashPointReached);

		return point;
	}

	function splashPointReached(obj){	
		if(surfer.isOnWave && wave.hasBreak==false) firstSplashPointReach(obj);
		showSplashPoint(obj);
	}
	function showSplashPoint(obj){
		var point = obj.target;		
		var splash = new createjs.Shape();
		splash.graphics.beginFill('#EEEEEE').drawCircle(0,0,2);
		point.addChild(splash);

		mask = new createjs.Shape();
		mask.graphics.beginFill('#FFF').drawRect(-wave.width/4,-wave.height,wave.width/2,wave.height);
		splash.mask = mask;

		var scale = wave.height - waveVariationHeight.x;
		scale = scale*0.40 +Math.random()*10;

		createjs.Tween.get(splash)
			.to({scaleX:scale,scaleY:scale},1000)
			.to({scaleX:scale-scale*0.2,scaleY:scale-scale*0.2},2500,createjs.Ease.easeOutSine);
	}
	function firstSplashPointReach(obj){
		console.log('Splashh');
		wave.hasBreak = true;
		setTimeout(initMovingWave,1000);
	}
	function initMovingWave(){
		console.log('init moving');
		if(surfer.x<=stage.width/2) wave.direction = 1;
		else wave.direction = -1;
		wave.moving = true;
				

	}
	function moveWave(){

		if(wave.moving == false) return;
		var x = wave.breaking_width*wave.direction;
		lip.x +=  x;
	}



	function drawLip(){

		//crée une nouvelle shape à chaque tick
		var shape = new createjs.Shape();
		//creé l'ensemble de points que la courbe doit suivre
		var points = [];
		var length = lip_points.length;
		//commencer par les points à gauche, en faisant un miroir des points de droite 
		//for(i=0; i<length; i++){
		//	points.push([wave.center-(lip_points[length-i-1].x-wave.center),lip_points[length-i-1].y]);
		//}
		//continuer par les points de droite 
		for(i=0; i<length; i++){
			points.push([lip_points[i].x,lip_points[i].y]);
		}
		//instancie la forme
		var k = shape.graphics.clear().beginFill('#FFFFFF');
		//se mettre au premier point
		k.moveTo(points[0][0],points[0][1]);
		//boucler en faisant passer la courbe par les points
		for( i=1; i<points.length -2; i++){

			var xc = (points[i][0]+points[i+1][0]) / 2;
			var yc = (points[i][1]+points[i+1][1]) / 2;
			k.quadraticCurveTo(points[i][0],points[i][1],xc,yc);
		}
		//faire passer par l'avant dernier point
		k.quadraticCurveTo(points[i][0],points[i][1],points[i+1][0],points[i+1][1]);		
		//le dernier point
		k.lineTo(points[0][0],points[0][1]);

		shape.alpha = 0.5;

		lipcurve.removeChildAt(0);
		lipcurve.addChild(shape);
		//lip.curveTo(100,100,500,100).draw(stage);
	}

	function drawWave(){

		var shape = new createjs.Shape();
		var points = [];
		var length = lip_points.length;
		for(var i=0; i<length; i++){
			points.push([lip_points[i].x,waveVariationHeight.x]);
		}
		
		var k = shape.graphics.clear().beginLinearGradientFill(["#092748","#0d568f"], [0, 1], wave.center, wave.height/5 + waveVariationHeight.x, wave.center, wave.height);
		k.moveTo(wave.x,wave.height);
		k.lineTo(wave.x,0);
		for(var i=1; i<points.length -2; i++){

			var xc = (points[i][0]+points[i+1][0]) / 2;
			var yc = (points[i][1]+points[i+1][1]) / 2;
			k.quadraticCurveTo(points[i][0],points[i][1],xc,yc);
		}
		k.quadraticCurveTo(points[i][0],points[i][1],points[i+1][0],points[i+1][1]);		
		k.lineTo(wave.x+wave.width,0);
		k.lineTo(wave.x+wave.width,wave.height);

		wave_bkg.removeChildAt(0);
		wave_bkg.addChild(shape);


	}

	function tick(){

		moveSurfer();
		drawLip();
		drawWave();
		moveWave();
		stage.update();

		//console.log(waveVariationBreakingTime.x);

	}

	</script>

</head>
<body onload="load()">

	<canvas id="myCanvas" width="1500" height="500" style="border: 1px solid grey; margin:0 auto 0 auto;">
		Sorry, your browser does not support Cancas element...
	</canvas>


</body>
</html>